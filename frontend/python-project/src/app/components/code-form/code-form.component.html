<form [formGroup]="form" class="code-form" (ngSubmit)="onSubmit()">
  <h3>YAML Data Form:</h3>

  <div cdkDropList (cdkDropListDropped)="drop($event)" class="drag-container">
    
    <div *ngFor="let item of yamlStructure; let i = index; trackBy: trackByIndex" cdkDrag class="form-row">
      
      <div class="insert-area" (mouseenter)="showInsertButton(i)" (mouseleave)="hideInsertButton()">
        <button *ngIf="showInsertIndex === i" (click)="insertLine(i)">+ Add Line</button>
      </div>

      <div class="form-item">
        
        <div cdkDragHandle class="drag-handle">☰</div>

        <!-- Display & Edit Comments -->
        <div *ngIf="item.type === 'comment'" class="form-comment">
          <span *ngIf="isEditing !== i" (click)="editLine(i)">{{ item.value || 'Enter comment' }}</span>
          <input *ngIf="isEditing === i && form.controls['comment_' + i]" 
                 [formControlName]="'comment_' + i" 
                 (blur)="saveEdit(i)" />
        </div>

        <div *ngIf="item.type !== 'comment'" class="display-inline">
          
          <!-- Editable Key Name -->
          <label *ngIf="item.type !== 'list' && item.show_name !== false">
            <span *ngIf="isEditing !== i" (click)="editLine(i)"><strong>{{ item.name || 'Untitled' }}</strong>:</span>
            <input *ngIf="isEditing === i && form.controls['key_' + i]" 
                   [formControlName]="'key_' + i" 
                   (blur)="saveEdit(i)" />
          </label>

          <!-- Editable Value -->
          <span *ngIf="isEditing !== i" (click)="editLine(i)">{{ item.value || 'Enter value' }}</span>
          <input *ngIf="isEditing === i && form.controls['value_' + i] && item.type === 'str'" 
                 [formControlName]="'value_' + i" type="text" (blur)="saveEdit(i)" />
          <input *ngIf="isEditing === i && form.controls['value_' + i] && item.type === 'int'" 
                 [formControlName]="'value_' + i" type="number" (blur)="saveEdit(i)" />

          <!-- Handling List Type -->
          <div *ngIf="item.type === 'list'">
            <div [formArrayName]="item.name">
              <label>{{ item.name }}:</label>
              <div *ngIf="getFormArray(item.name) as subFormArray">
                <div *ngFor="let subItem of subFormArray.controls; let j = index" [formGroupName]="j">
                <input [formControlName]="'value'" type="text" />
                <button type="button" (click)="deleteFieldFromList(item.name, j)">Remove</button>
              </div>
              </div>
            </div>
            <button type="button" (click)="addFieldToList(item.name)">Add Field</button>
          </div>

          <!-- Handling Dict Type -->
          <div *ngIf="item.type === 'dict'">
            <code-form-component [yamlStructure]="item.fields"></code-form-component>
          </div>
        </div>

        <div class="move-buttons">
          <button *ngIf="i > 0" (click)="moveLine(i, i - 1)">▲</button>
          <button *ngIf="i < yamlStructure.length - 1" (click)="moveLine(i, i + 1)">▼</button>
          <button (click)="editLine(i)">Edit</button>
          <button (click)="deleteLine(i)">Delete</button>
        </div>
      </div>

    </div>

    <div class="insert-area" (mouseenter)="showInsertButton(yamlStructure.length)" (mouseleave)="hideInsertButton()">
      <button *ngIf="showInsertIndex === yamlStructure.length" (click)="insertLine(yamlStructure.length)">+ Add Line</button>
    </div>

  </div>
</form>
